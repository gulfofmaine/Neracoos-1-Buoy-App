version: v1.0
name: NERACOOS Mariner's Dashboard Build and Test
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: "Install"
    task:
      prologue:
        commands:
          - sem-version node 10.13.0
          - checkout
          - cache restore node-modules-$(checksum yarn.lock)
          - cache restore cypress=3.1.2
          - mv home/semaphore/.cache/Cypress/ ~/.cache/Cypress/ || true

      jobs:
      - name: Build Yarn modules
        commands:
          - yarn --frozen-lockfile
          - cache store node-modules-$(checksum yarn.lock) node_modules
          - cache store cypress=3.1.2 ~/.cache/Cypress

  - name: "Tests"
    task:
      secrets:
        - name: neracoos_mariners_dashboard_env

      prologue:
        commands:
          - sem-version node 10.13.0
          - checkout
          - cache restore node-modules-$(checksum yarn.lock)
          - cache restore cypress=3.1.2
          - mv home/semaphore/.cache/Cypress/ ~/.cache/Cypress/
          - sudo apt-get update && sudo apt-get install -y xvfb libgtk2.0-0 libnotify-dev libgconf-2-4 libnss3 libxss1 libasound2

      jobs:
      - name: Unit Tests
        commands:
          - yarn test-with-codacy-coverage

      - name: Integration Tests
        commands:
          - yarn start & yarn run wait-on http://localhost:3000/
          - yarn run cypress run --record --key 9719f2cf-c8c6-423c-ac09-68004e35b6c7
